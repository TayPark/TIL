# ELB

- Elastic Load Balancer
  - AWS의 L4/L7 로드밸런싱 서비스
  - 외부/내부에서 들어오는 클라이언트의 요청을 ELB에 연결된 AZ의 EC2에 고르게 나누어 전달하고, 등록된 EC2의 상태를 검사
  - 외부/내부 트래픽은 ELB의 DNS 주소를 목적지로 하여 들어오며 이 트래픽을 받은 ELB는 AZ에 등록된 EC2에 전달
  - 보안 그룹 적용
  - ELB 또한 VPC 내에 존재, 퍼블릭/프라이빗 IP를 모두 가질 수 있음
    - 인터넷 연결 옵션: 퍼블릭/프라이빗 IP 생성
    - 내부 옵션: 프라이빗 IP 생성
  - **기본적으로 포트를 이용하여 로드밸런싱**
  - ELB는 리스너를 거느리며 리스너 하나당 요청을 받아들이는 포트 하나씩을 지정
    - HTTP 리스너, HTTPS 리스너 등
  - 상태 검사에서 성공한 EC2만이 요청 로드 밸런싱 대상
  - SSL 인증서를 등록하여 HTTPS 암/복호화 통신을 대신하는 SSL Offload 가능
  - 세 가지 로드밸런서로 구성
    - ALB(Application, L7)
    - NLB(Network, L4)
    - CLB(Classic)
  - 대상 그룹(Target Group)
    - ELB에 등록된 EC2 인스턴스들의 그룹
    - 대상 그룹에 등록된 EC2, EC2 상태, 상태 검사 방법 등 정의
    - 상태 검사 방법에는 HTTP, HTTPS, TCP 등
    - 방법뿐만 아니라 상태 검사에 필요한 시간도 정의 가능
    - ALB와 NLB는 대상 그룹을 지정하며, CLB는 로드밸런서에 직접 등록
  - ALB
    - L7 로드밸런서
      - HTTP/HTTPS 헤더 정보를 기반으로 로드밸런싱
    - 요청에 따라 고정 페이지를 반환하거나 다른 경로로 리다이렉트
    - HTTP 헤더 / HTTP method / Host 헤더 / Source IP 등을 이용하여 요청 전달 가능
    - SSL 인증서를 이용하여 SSL Offload 지원
    - 교차 영역 로드밸런싱 지원
    - X-forward-for 를 지원하여 EC2로 하여금 클라이언트의 IP를 확인할 수 있도록 함
    - ALB가 소유한 공인 IP가 유동적으로 변경
  - NLB
    - L4 로드밸런서
    - TCP/UDP 기반으로 로드밸런싱
    - 프로토콜, 원본 IP 주소, 원본 포트, 목적지 IP 주소, 목적지 포트, TCP Seq#를 이용하여 로드밸런싱
    - Client IP를 변경하지 않고 서버에 전달
    - IP 고정
    - 교차 영역 로드밸런싱 지원
  - CLB
    - EC2-classic을 사용하는 경우 CLB를 사용
    - TCP/HTTP/HTTPS 지원
    - X-forward-for 지원
    - 교차 영역 로드밸런싱 지원
  - Sticky Session
    - 세션 고정 기능
    - 하나의 요청이 특정 EC2로 들어온 후에 세션이 생성되었다가 종료되고, 들어왔던 요청이 다시 들어올 경우 연결되었던 EC2로 전달하는 기능
  - 교차영역 로드밸런싱
    - ELB는 대상그룹에 등록된 EC2별로 적절히 로드밸런싱 하는 것이 아닌 **가용영역별로 비율을 나눔**
      - 교차 영역이 2개라면 50%씩 전달
      - 만약 A AZ에 2개의 인스턴스, B AZ에 8개의 인스턴스가 존재하면 A AZ 인스턴스의 부하가 심해짐
      - 이를 방지하기 위해 교차영역 로드밸런싱을 활성화하면 **EC2 갯수를 기반으로 계산하여 전달**
  - X-Forward-for
      - Client IP를 담고있는 HTTP Header
      - EC2 내 서비스가 Client IP를 확인할 필요가 있는 경우 ELB가 해당 값 장착하여 전달
  - 연결 드레이닝(Connection draining)
      - 오토스케일링과 ELB를 함께 사용시 필요에 따라 EC2가 없어질 경우, 해당 EC2에 요청이 들어와있다면 사용중인 세션이 피해를 볼 수 있음
      - 삭제되기 직전에 유휴 세션이 작업을 마칠 때까지 기다리는 기능

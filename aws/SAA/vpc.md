# VPC

- `VPC(Virtual Private Cloud)`
  - AWS의 계정 전용 가상 네트워크 서비스
  - 다른 가상 네트워크와 논리적으로 분리
  - S3, Cloudfront 등 비 VPC 서비스가 존재하며, VPC 내에서 생성되지 않음
    - VPC 외부이기 때문에 네트워크 통신 비용 부가
  - 각 리전별로 별도의 VPC가 다수 존재할 수 있음
  - VPC는 하나의 프라이빗 IP 대역을 보유하고 서브넷을 생성하며 프라이빗 IP 대역 일부를 나눠줄 수 있음
  - 허용된 IP 블록 크기는 /16(65536) ~ /28(16)
  - 권고하는 VPC CIDR 블록
    - 10.0.0.0 ~ 10.255.255.255(10.0.0.0/8)
    - 172.16.0.0 ~ 172.31.255.255(172.16.0.0/12)
    - 192.168.0.0 ~ 192.168.255.255(192.168.0.0/16)
- 서브넷
  - VPC 내 생성되는 분리된 네트워크로 하나의 서브넷은 하나의 AZ에 연결
  - VPC가 가지고 있는 프라이빗 IP 범위 내에서 서브넷을 쪼개서 사용 가능
  - 실제 리소스들은 서브넷 내에 생성되며 프라이빗 IP를 할당받고 필요에 따라 퍼블릭 IP 할당
  - 하나의 서브넷은 라우팅 테이블과 하나의 NACL(Network Access Control List)를 가짐
  - 서브넷에서 생성되는 리소스에 퍼블릿 IP 자동 할당 여부 설정 가능
  - 이 기능을 통해 **퍼블릭 서브넷과 프라이빗 서브넷**을 만들어 커스터마이징 가능
    - IGW(Internet GateWay)로 라우팅 되는 경우 퍼블릭 서브넷, 그렇지 않은 경우 프라이빗 서브넷으로 분류
  - 각 서브넷의 CIDR 블록에서 4개의 IP 주소(0~3)와 마지막(255) IP 주소는 예약 주소로 사용자가 사용할 수 없음. 예를 들어 서브넷 주소가 172.16.1.0/24 일 경우
    - 172.16.1.0: 네트워크 주소(Network ID)
    - 172.16.1.1: VPC Router용 예약 주소(Gateway)
    - 172.16.1.2: DNS 서버의 IP 주소
    - 172.16.1.3: 예약 주소
    - 172.16.1.255: 네트워크 브로드캐스트 주소(VPC는 브로드캐스트 미지원)
- `ENI(Elastic Network Interface)`
  - 가상 네트워크 인터페이스
  - VPC 내 리소스들은 ENI와 사설 IP를 기본적으로 할당
  - 선택적으로 퍼블릭 IP도 할당 가능
  - 퍼블릭 서브넷의 경우, 리소스 생성시 자동으로 퍼블릭 IP 할당
  - 프라이빗 IP는 추가로 할당 가능하며 퍼블릭 IP 역시 나중에 할당 가능
- `라우팅 테이블(Routing Table)`
  - 서브넷 내의 트래픽이 전송되는 위치를 결정하는 라우팅 규칙 집합
  - 라우팅 테이블은 기본적으로 VPC 범위에 해당하는 범위를 기본 라우팅으로 가짐
  - Internet Gateway, NAT Gateway, VPC Endpoint, Peering 등을 설정하고 그 서비스로 트래픽을 보내도록 라우팅 설정 가능
  - 0.0.0.0/0 은 default routing을 뜻하며, 트래픽이 가고자하는 목적지가 라우팅 테이블에 없을 경우 사용하는 라우팅.
    - 보통 Internet Gateway나 NAT Gateway로 외부 인터넷을 지정할 때 사용
  - **하나의 서브넷은 하나의 라우팅 테이블을 가지지만, 하나의 라우팅 테이블은 다수의 서브넷을 가질 수 있음**
  - 퍼블릭 서브넷의 라우팅 테이블에는 IGW로의 라우팅이 있으며, 프라이빗 서브넷에서 외부 인터넷 통신이 필요할 경우 NAT Gateway로의 라우팅이 잡혀있음
- `인터넷 게이트웨이(IGW, Internet Gateway)`
  - VPC 내 리소스가 외부 인터넷을 사용하고자 할 때 사용하는 게이트웨이
    - IGW가 없으면 외부 인터넷 사용 불가능
  - IGW를 생성한 후, 0.0.0.0/0에 대한 라우팅 테이블을 IGW로 잡아주면 사용 가능
  - IGW가 있더라도 VPC 내 리소스가 퍼블릭 IP를 가지고 있지 않다면 인터넷 사용 불가능
  - 또한 위의 설정은 모두 하더라도 인터넷이 제대로 되지 않는다면 NACL을 확인해야 함
- `NAT Gateway`
  - 외부에서 접촉이 차단된 프라이빗 서브넷에서 인터넷 접속을 통해야 할 경우 사용하는 게이트웨이
  - VPC 내부 리소스가 NAT Gateway를 통해 인터넷을 접속할 수 있지만, 외부에서 NAT Gateway를 통해 VPC 내부로 들어올 수 없음
    - 인터넷이 연결된 퍼블릭 서브넷에 NAT Gateway(EIP를 가진)를 생성한 후, 프라이빗 서브넷의 라우팅 테이블에 0.0.0.0/0에 대해 라우팅을 NAT Gateway로 잡으면 사용 가능
  - **CloudWatch를 통해 모니터링 가능**
- `NAT Instance`
  - 퍼블릭 서브넷에 생성된 NAT Gateway 대신 EC2 인스턴스를 사용하는 방법
  - 퍼블릭 서브넷에 퍼블릭 IP를 가진 인스턴스를 게이트웨이로 삼고, 프라이빗 서브넷의 라우팅 테이블에 0.0.0.0/0에 대해 해당 인스턴스로 설정한 후, **SrcDestCheck**설정을 비활성화
  - 커뮤니티 AMI에 있는 ami-vpc-nat로 시작하는 인스턴스로 사용 가능
  - 인스턴스이기 때문에 보안 그룹의 설정을 적용받아 트래픽 제어 가능
  - vs. NAT Gateway
    - NAT Instance는 사용자가 직접 관리
    - NAT Instance는 장애가 발생할 수 있어 Failover 신경 써야함
    - NAT Gateway는 대역폭을 최대 45Gbps까지 확장할 수 있지만, NAT Instance는 인스턴스 유형에 달림
    - NAT Instance는 보안 그룹을 사용할 수 있음
    - 모두 NACL을 통해 트래픽 제어 가능
- `보안그룹(Security Group)`
  - VPC 내 인스턴스에 대한 인바운드/아웃바운드 트래픽을 제어하는 가상의 방화벽
  - 인스턴스 수준에서 작동하므로 인스턴스마다 다른 보안 그룹으로 지정 가능
  - 기본적으로 모든 인바운드 트래픽을 거부하고 모든 아웃바운드 트래픽 허용
  - 인스턴스당 최대 5개 보안 그룹 설정 가능
  - 인바운드와 아웃바운드 트래픽 별도로 설정 가능하며, **Stateful** 특성을 가짐
    - 인바운드에 80포트가 허용되어있지만 아웃바운드에 없어도 통신 지장 없음
  - **허용 규칙만 존재**
  - 설정 변경시 즉시 적용
- `NACL(Network ACL)`
  - 서브넷 내부와 외부의 트래픽을 제어하기 위한 가상 방화벽. 네트워크 스위치의 ACL와 역할이 같음
  - 서브넷의 가상 방화벽이기 때문에 서브넷에 속한 모든 인스턴스가 영향 받음
  - 기본적으로 모든 트래픽 허용
  - 하나의 ACL은 다수의 서브넷과 연결될 수 있으며, 하나의 서브넷은 하나의 ACL만 연결
  - 인바운드 규칙과 아웃바운드 규칙이 서로 영향을 줌(**Stateless**)
    - 인바운드에 80 포트가 허용되어있지만 아웃바운드에 없으면 트래픽이 나가지 않음
  - **허용과 거부 모두 가능**
  - 보안그룹과 달리 **우선순위 값이 존재**하며, **작은 값이 높은 우선순위**를 가짐
  - 변경 사항은 잠시 후 적용
  - **보안그룹 vs. NACL**
    - Stateful / Stateless
    - 트래픽 허용만 가능 / 허용, 거부 가능
    - 규칙 리스트에 있는 것 중 적용 / 우선 순위에 따라 우선 규칙 적용
    - 인스턴스의 가상 방화벽 / 서브넷의 가상 방화벽
- VPC Peering
  - 두 VPC 간 트래픽을 전송하기 위한 기능
  - 다른 리전의 VPC를 Destination 으로 선택하여 피어링 요청을 보낸 후 수락시 피어링 가능
    - 다른 계정의 VPC도 연결이 가능
  - 피어링 생성 후 라우팅 테이블에 해당 피어링을 넣으면 통신 시작
  - VPC 피어링은 Transit Routing 불가(2개의 VPC가 하나의 VPC를 통해 통신하는 행위)
- VPC Endpoint
  - VPC 내 요소들과 VPC 서비스(S3, CloudWatch, Athena 등)을 외부 인터넷을 거치지 않고 아마존 백본 네트워크를 통해 연결하는 방법
  - Direct Connect(전용선 서비스), VPN, IGW와 같은 외부 연결이 되어있지 않은 서비스에서 아마존의 서비스 연결 가능
    - 간단히 말하면 AWS 서비스 전용선
  - VCP 엔드포인트에는 Interface Endpoint, Gateway Endpoint가 존재
    - **Gateway Endpoint는 S3와 DynamoDB만 가능**
- VPN
  - AWS IPSec VPN 서비스
  - AWS와 온프레미스 VPN 연결 가능
- Direct Connect
  - 전용선 서비스
  - VPN보다 안전하고 빠른 속도를 보장받고 싶을 때 사용
  - 표준 이더넷 광케이블을 이용하여 케이블 한쪽을 사용자 네트워크의 라우터에 연결하고 다른 한 쪽은 Direct Connect 라우터에 연결하여 내부 네트워크와 AWS VPC 연결
  - AWS Region --- Direct Connect Location --- Customer

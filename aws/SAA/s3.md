# S3 and Cloudfront

- `S3(Simple Storage Service)`
  - HTTP를 이용하여 언제 어디서나 데이터를 저장하고 검색할 수 있는 스토리지
  - 버킷과 객체로 나뉘며, 하나의 버킷에 여러 객체를 담을 수 있음
  - S3 자체는 글로벌 서비스(Region, AZ 무관)이지만 버킷을 생성할 때에는 리전을 선택해야 함
  - 객체는 객체 데이터와 메타 데이터로 나뉘며, 각자의 고유한 URL을 가짐
  - `버킷`
    - 객체를 담고있는 구성 요소
    - 크기 무제한. 리전을 지정하여 버킷 생성
    - 버킷의 이름은 반드시 고유
  - `객체`
    - S3에서 취급하는 데이터 중 나눌 수 없는 최소 단위
    - 키, 버전ID, 값, 메타데이터 등으로 구성
    - 1 byte ~ 5TB 까지 가능
    - 스토리지 클래스, 암호화, 태그, 메타데이터, 객체 잠금 설정 가능
    - 객체의 크기가 매우 클 경우 멀티파트 업로드를 통해 신속하게 업로드 가능
  - 객체의 `스토리지 클래스`
    - 객체의 접근 빈도 및 저장 기간에 따라 결정되는 객체의 특성
    - 스탠다드: 기본 옵션.
    - 스탠다드_IA(Ifrequent Access): 자주 액세스하지는 않지만 즉시 액세스할 수 있는 데이터의 클래스
    - One Zone_IA: 스탠다드 IA와 거의 유사하나 스탠다는 3개의 AZ에 저장되는 것과 달리 한 곳의 AZ에만 저장되는 클래스(저장 요금 인하)
    - Intelligent tiering: 액세스 빈도가 불규칙하여 빈도를 가늠하기 어려운 경우 선택되는 클래스
    - Glacier: 검색이 아닌 저장이 주 용도인 스토리지. 검색에 3-5시간 소요
    - Glacier deep archive: 10년 이상 저장할 데이터를 저장하는 스토리지 클래스.
  - 멀티파트 업로드(Multipart upload)
    - 오브젝트 크기가 클 경우 조각내어 병렬적으로 처리하는 방법
    - 객체 크기가 100MB 이상일 경우 권장하며, 최대 크기는 5TB
    - 조각의 갯수는 최대 1만개까지 가능하며, 조각의 크기는 대략 5MB~5GB
  - `버전 관리(Version Management)`
    - 동일한 객체에 대해 여러 버전을 가질 수 있도록 하는 기능
    - 객체를 삭제하더라도 삭제 마커를 붙여 다시 복구할 수 있는 기능 제공
  - `Lifecycle Management`
    - S3에 있는 오브젝트를 **일정 시간 후에 다른 타입으로 변경**하는 것을 의미
      - 자주 사용하던 Standard Type 객체를 Glacier 타입으로 변경하는 등
    - 현재 버전과 이전 버전에 대해 설정 가능
    - 완료되지 않는 멀티파트 업로드와 버전 관리가 적용된 오브젝트의 삭제 마커를 정리할 수 있음
    - 더 이상 사용하지 않은 오브젝트에 대해 만료 기간을 설정하여 정한 기간 후 삭제하도록 설정 가능(만료 기간 설정)
    - Standard_IA와 One Zone IA 는 보관 후 30일 이후 이전 가능
  - 정적 웹 사이트 호스팅
  - `암호화`
    - 클라이언트 사이드, 서버 사이드로 나뉨
      - `클라이언트 사이드`는 클라이언트에서 S3로 전송될 때의 암호화(data at transit)
        - S3로 데이터를 보내기 전의 암호화
        - KMS에 저장된 CMK를 사용하여 암호화
        - 애플리케이션 내 마스터 키를 사용하여 암호화
      - `서버 사이드`는 S3에 저장될 때의 암호화(data at rest)
        - SSE-S3: S3의 고유한 키로 암호화를 실시하며, 암호화 주체가 S3에 되는 방식. AES-256 사용
        - SSE-KMS: KMS 고객 마스터 키(CMK) 사용. 고객이 키를 제어 가능
        - SSE-C: 고객이 제공하는 키로 암호화는 진행하는 방식. 키는 서버에 저장되지 않음
  - 전송 속도 향상(Transfer Acceleration)
    - Cloudfront의 Edge Location을 이용하여 파일 업로드를 보다 빠르게 하는 기능
    - S3로 직접 업로드 하지 않고 가장 가까운 Edge Location으로 전송하고 아마존 백본 네트워크를 통해 S3에 도달

- `Cloudfront`
  - CDN(Contents Delivery Network) 서비스
    - HTTP/HTTPS를 이용하여 ELB, EC2, 외부 서버 등을 캐싱하고 보다 빠른 속도로 컨텐츠를 전달하는 캐시서버
  - 전 세계에 퍼져있는 Edge Location의 주변 Origin Server의 컨텐츠를 Edge Location에 캐싱하고 각 Edge Location간 공유를 통해 컨텐츠 전달
  - Distribution은 Edge Location의 집합을 의미
  - S3, ELB, EC2 등의 AWS 서비스 뿐만 아니라 외부의 서버도 캐싱 가능(Custom Origin 이라 함)
  - TTL을 조절하여 캐시 주기 통제
  - 컨텐츠 제공 방법
    - 사용자가 정적 컨텐츠 요청
    - DNS가 최적의 요청을 위해 Cloudfront Edge Location으로 요청을 라우팅
    - Edge Location에서 해당 캐시에 요청된 파일이 있는지 확인하고 없으면 오리진 서버에 요청하여 확보 후 전달, 그리고 캐싱
  - OAI(Origin Access Identity)
    - S3를 오리진 서버로 사용시, Cloudfront를 제외하고 다른 경로로 S3를 접근하는 것을 막는 방법
    - OAI를 설정하면 각각의 Distribution이 별도의 Identity를 갖게되며, S3의 버킷 정책을 수동 혹은 자동으로 수정할 수 있음
  - Presigned URL
    - 인증된 사용자만 해당 Distribution을 사용할 수 있도록 제어하는 기능
    - 만료 날짜 및 시간 설정 가능
    - Cloudfront 설정 시 Presigned URL 사용과 Cloudfront Keypair를 계정의 IAM에서 생성해야 함
    - 이를 조합하여 URL 서명을 생성하고 URL을 통해 Cloudfront 접근 가능

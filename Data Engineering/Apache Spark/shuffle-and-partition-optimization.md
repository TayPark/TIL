source: https://tech.kakao.com/2021/10/08/spark-shuffle-partition/

# Spark Partition

파티션은 서로 다른 노드에서 분산처리되는 최소 단위 객체. RDD나 DataSet을 구성한다.

스파크에서 하나의 최소 연산을 Task라고 하는데, 이 하나의 Task에서 하나의 파티션이 처리된다. 또한 하나의 Task는 하나의 Core가 처리한다.

즉, **1 Core = 1 Task = 1 Partition**

그렇기 때문에 스파크에서 **하나의 코어에서 한 번에 처리할 수 있는 태스크를 위해 파티션의 크기를 잘 결정하는 것이 중요**하다.

만약 100GB를 처리한다고 가정해보자. 파티션을 10개로 나눈다면 각 파티션은 10GB씩 나눠질 것이다. 파티션이 100개라면 각 파티션은 1GB가 된다.

즉, **적은 수의 파티션 = 큰 파티션 = 낮은 병렬화**이고, **많은 수의 파티션 = 크기가 작은 파티션 = 높은 병렬화**임을 명심하자.

## 파티션의 종류

파티션은 용도에 따라 3개로 구분할 수 있다.

- Input
  - 처음 파일을 읽을 때 생성하는 파티션. 기본 값은 128MB.
  - 파일의 크기가 크다면 128MB씩 쪼개서 읽고, 작다면 그대로 읽음(파일 하나당 하나의 파티션)
  - 대부분의 경우, 필요한 컬럼만 뽑아 쓰기 때문에 128MB보다 작지만 큰 파일을 다룰 때에는 설정 값을 조절하자.
  - `spark.sql.files.maxPartitionBytes`
- Output
  - 파일을 저장할 때 생성하는 파티션. 이 파티션의 수가 경로에서의 마지막 파일 수를 지정
  - HDFS에서는 큰 파일을 잘 다루도록 설계되어있어, 크기가 큰 파일로 저장하는 것이 좋음
  - 통상적으로 하둡 클러스터 HDFS Blocksize에 맞게 설정
  - `df.repartition(cnt)`, `df.coalesce(cnt)`로 설정할 수 있음.
    - `df.where()`을 통해 필터링을 진행하면 데이터 파편화가 생긴다. df.repartition(cnt) 후 저장하면 조절이 가능하다.
- Shuffle
  - Join, groupBy 등 연산을 수행할 때 쓰이는 파티션
  - `spark.sql.shuffle.partitions`로 조절
    - 파티션의 크기에 맞춰 설정해야 함
  - 파티션의 크기가 크고 연산에 쓰이는 메모리가 부족하다면 **Shuffle Spill(데이터를 직렬화하고 저장한 후, 역직렬화하여 연산 재개)**가 발생
    - 이는 태스크 지연과 에러가 발생할 수 있음. 
  - 메모리 부족으로 나타나는 경우가 많기에 코어당 메모리를 늘리는것으로 해결할 수 있지만 **파티션 수를 조절하는것을 우선으로 고려**
  - 일반적으로 셔플 파티션 크기가 100~200MB 정도 나올 수 있도록 파티션 수를 조절하는것이 최적

## 결론

- 최적화의 우선순위는 **쿼리 > 파티션 수 > 코어 당 메모리 증가**
  - groupBy 집계 후 Join을 하고(카티션 곱 최소화)
  - 파티션 수를 조절해보고
  - 그래도 안된다면 코어 당 메모리를 증가시켜야 함
- 파티션 수를 증가시키면 태스크 수도 늘어나지만 **Shuffle Spill이 일어나지 않는다면 시간이 더 감소**
  - 그러므로 **셔플 파티션 크기를 100~200MB로 설정하는 것이 중요**
  - 더 작게 만든다면 병렬성은 높아지나 GC 시간이 늘어남
- 셔플 사이즈가 600GB에 가깝거나 그 이상이면 Core 당 메모리를 증가시키는 것을 권장
  - 코어당 4GB 고려
- Spark ML을 사용하거나 Caching을 하는 경우, Spark 메모리 구조 중 Storage Memory Fraction 부분에서 캐싱 수행
  - 연산 메모리가 줄어 메모리 증대가 필요

1. 그럼 셔플 사이즈는 어떻게 구하나?
  - 셔플 사이즈는 인풋 데이터 사이즈이다.
2. 그럼 스트리밍 환경에서는 어떻게 처리하나?
   1. 마이크로 배치 텀마다 들어오는 데이터의 크기에 따라 데이터가 달라질 것 같다. 수 번의 테스트로 튜닝을 시도해야 좋은 결과를 얻을 수 있을 것이라 생각된다.

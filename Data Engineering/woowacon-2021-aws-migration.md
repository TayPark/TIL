# 데이터 분석 플랫폼, 지상계에서 천상계로 배달완료!

우아한형제들의 데이터 분석 플랫폼 AWS 이관기 https://www.youtube.com/watch?v=rH_xJBoRuZE

## 전사 구성원의 데이터 접근 지향

- 셀프 서비스 지향
  - SQL, 대시보드, 배치 작업 등 모두 셀프


## 히스토리

- 초창기: AWS EMR 사용
  - Zepplin 및 Presto 별도 설치
    - 낮은 버전 이슈와 커스터마이징을 위함
    - 보안 접근 제어는 Zepplin 만 적용
- 사용자가 늘어나고 분석이 많아지자 Zepplin 이 느려지기 시작
  - 장비를 구매하여 IDC에서 구성
- 서비스가 성장하고 데이터거 늘어나면서 한계에 도달
  - 장비 구매 속도보다 데이터 증가 속도가 더 빨라짐
- 현재
  - 리소스 제한 없는 AWS로 다시 이관
  - Presto 계열의 Trino 사용
  - 새 버전 Zeppelin
  - 접근 제어를 위해서는 IAM의 제한을 벗어나기 위해 Apache Ranger 그대로 이용
- 아테나를 사용하지 않는 이유
  - 벤치마크 테스트결과, 다른 비교대상(EMR, Trino, Trino-docker)보다 성능이 떨어짐
  - AWS 계정에 할당되는 리소스가 제한되고 Presto 버전이 낮다보니 나쁜 결과를 얻게됨
  - JVM 메모리 등, 튜닝이 어려움
  - 설치 편의성이나 이식성을 위해 Trino 사용
- Trino 도입기
  - 분산 SQL 쿼리 엔진
  - 메모리 기반 병렬 처리
  - Presto에서 포크된 프로젝트
  - Presto DB에서 PrestoSQL로 분기하여 Trino로 리브랜딩
  - 더 많은 commit
  - 도커 이미지
    - 도입 당시의 Trino는 julu jdk 기반이었음
      - 현재는 ARM64를 지원하지만, 그 당시에는 x86에서만 사용 가능
      - ARM64를 지원하도록 이미지를 자체 개발
      - `docker buildx` 를 이용하여 다중 아키텍처 빌드
  - 보안
    - 클라이언트 정보에 따른 쿼리 접근 제어
    - 쿼리 로깅
    - 이벤트에 대해 호출되는 커스텀 리스너를 제작할 수 있도록 지원
      - 쿼리 생성
      - 쿼리 완료
      - 분할(Task) 완료
  - 모니터링
    - JMX exporter를 이용하여 프로메테우스 - 그라파나로 모니터링
  - Presto 에서 Trino 변경 시 어려웠던 점
    - Presto에서는 처리량 제한을 위해 입력받은 쿼리를 서브쿼리로 넣고 실행하도록 구성
      - ORDER BY 후 LIMIT을 걸어 요구사항 존재했지만 Trino 에서는 미지원
        - Trino에서는 SQL 표준을 준수하고 성능 개선을 하기 위한 일환임
        - 서브쿼리에서 정렬을 무시하는 것을 기본으로 수행
    - 추후 개발할 것으로 공지를 했지만 지금 지원하지는 않음
    - 데이터를 내려받고 쿼리 실행을 중단하도록 변경